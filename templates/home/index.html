{% extends "base.html" %}
{% load static %}
{% block title %} Dashboard {% endblock %} 

<!-- Specific CSS goes HERE -->
{% block stylesheets %}
<link rel="stylesheet" href="{% static 'plugins/full-calendar/full-calendar.css' %}">
{% endblock stylesheets %}

{% block content %}
    <!-- [ Main Content ] start -->
    <div class="pcoded-main-container">
        <div class="pcoded-wrapper">

            <div class="pcoded-content">
                <div class="pcoded-inner-content">
                    <!-- [ breadcrumb ] start -->

                    <!-- [ breadcrumb ] end -->
                    <div class="main-body">
                        <div class="page-wrapper">
                            <!-- [ Main Content ] start -->
                            <div class="row">
                                <div class="col-xl-8"> 
                                    <div class="card"> {% comment "" %} Assessments {% endcomment %}
                                        <div class="card-header">
                                            <h5>Assessments</h5>
                                            {% if 'add_assessments' in USER_PERMISSIONS%}
                                            <code> <a href="{% url 'assessment_add' %}" class="nav-link ">Add new Assessment</a> </code>
                                            {%endif%}
                                        </div>                                    
                                        <div class="card-block table-border-style">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Assessment Name</th>
                                                            <th>Client</th>
                                                            
                                                            <th>Start Date</th>
                                                            <th>End Date</th>
                                                            <th>Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for assessment in assessments %}
                                                        <tr>
                                                            <td><a href="/assessments/{{assessment.id}}/summary"> {{ assessment.name }}</a> </td>  
                                                             <td>{{ assessment.client }}</td>

                                                             <td>{{ assessment.start_date|date:"F d, Y"  }}</td>
                                                            <td>{{ assessment.end_date|date:"F d, Y"  }}</td>

                                                            {% comment %} Status with color formating{% endcomment %}
                                                            {% if assessment.status.name == "In progress"%}
                                                            <td><a class="label theme-bg text-white f-12"> {{ assessment.status }}</a></td>
                                                            {% else %} 
                                                            <td><a class="label theme-bg2 text-white f-12"> {{ assessment.status }}</a></td>
                                                            {%endif%} 
                                                            
                                                        </tr>                                         
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>


                                    <div class="card fullcalendar-card">
                                        <div class="card-header">
                                            <h5>Calendar</h5>
                                        </div>
                
                                        <div class="card-block">
                                            <div class="row">
                                                <div class="col-xl-12 col-md-12">
                                                    <div id='calendar' class='calendar'></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                
                                </div>
                                
                                <div class="col-xl-4 col-md-6">
                                    <div class="card">
                                        <div class="card-block border-bottom">
                                            <div class="row d-flex align-items-center">
                                                <div class="col-auto">
                                                    <i class="feather icon-edit f-30 text-c-green"></i>
                                                </div>
                                                <div class="col">
                                                    <h3 class="f-w-300">{{in_progress_assessments}}</h3>
                                                    <span class="d-block text-uppercase">In Progress Assessments</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-block">
                                            <div class="row d-flex align-items-center">
                                                <div class="col-auto">
                                                    <i class="feather icon-check-square f-30 text-c-blue"></i>
                                                </div>
                                                <div class="col">
                                                    <h3 class="f-w-300">{{closed_assessments}}</h3>
                                                    <span class="d-block text-uppercase">Compleated Assessments</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card card-event">
                                        <div class="card-block">
                                            <div class="row align-items-center justify-content-center">
                                                <div class="col">
                                                    <h5 class="m-0">Total Vulnerabilities Found</h5>
                                                </div>
                                            </div>
                                            <h2 class="mt-3 f-w-300">{{total_vuln_found}}</h2>
                                            <i class="fas fa-search text-c-purple f-50"></i>
                                        </div>
                                    </div>
                                    
                                    <div class="card card-event">
                                        <div class="card-block">
                                            <div class="row align-items-center justify-content-center">
                                                <div class="col">
                                                    <h5 class="m-0">Tasks Assigned</h5>
                                                </div>
                                            </div>
                                            <h2 class="mt-3 f-w-300">{{tasks_assigned_to_user}}</h2>
                                            <i class="fas fa-tasks text-c-blue f-50"></i>
                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>            

    <script src="{% static 'plugins/full-calendar/full-calendar.js' %}"></script>
{{ block.super }}
<script type="text/javascript">
    var header;
    if (window.innerWidth <= 768) { 
        header = {
            left: '',
            center: 'title',
            right: 'prev,next'
        };
    } else {
        header = {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek'
        };
    }

    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            headerToolbar: header,
            themeSystem: 'bootstrap',
            navLinks: true,
            droppable: false,
            selectable: false,
            editable: false,
            dayMaxEvents: 3,
            handleWindowResize: true,
            height: 600,
            events: {% autoescape off %}{{ events|safe }}{% endautoescape %}
        });
        calendar.render();
    });
</script>
    {% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<!-- Add grey color to js calendar header-->
<script>
    function setBlackColorForHeaders() {
        const headerLinks = document.querySelectorAll('.fc-col-header-cell-cushion');
        for (const link of headerLinks) {
            link.style.color = '#505050';
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        setBlackColorForHeaders();
    });
    
</script>

{% endblock javascripts %}
